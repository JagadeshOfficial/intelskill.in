name: Deploy and Fix VPS

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy-and-fix:
    runs-on: ubuntu-latest
    steps:
      - name: SSH, Optimize, and Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME || 'root' }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.PORT || 22 }}
          script: |
            echo "Starting Deployment and Optimization..."
            
            # 1. SWAP SPACE CHECK & CREATION
            if [ $(free -m | grep Swap | awk '{print $2}') -eq 0 ]; then
                echo "No swap detected. Creating 2GB swap file..."
                sudo fallocate -l 2G /swapfile
                sudo chmod 600 /swapfile
                sudo mkswap /swapfile
                sudo swapon /swapfile
                echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
                echo "Swap created successfully."
            else
                echo "Swap space already exists."
                free -m
            fi

            # 2. DISK CLEANUP
            echo "Cleaning up unused Docker resources..."
            docker system prune -af --volumes

            # 3. LOCATE AND DEPLOY PROJECT
            PATHS=(
              "/home/intelskill.in/Learn_Flow_Full"
              "/home/intelskill.in"
              "/home/ubuntu/Learn_Flow_Full"
              "/var/www/intelskill.in"
              "/home/mathisi.in/Learn_Flow_Full" 
              "/root/Learn_Flow_Full"
            )
            
            FOUND=0
            
            for DIR in "${PATHS[@]}"; do
              if [ -d "$DIR" ] && [ -f "$DIR/docker-compose.yml" ]; then
                echo "Found project at: $DIR"
                cd "$DIR"
                
                # Check for updates and restart
                echo "Pulling latest images..."
                docker compose pull
                
                echo "Restarting containers with update..."
                docker compose up -d --remove-orphans
                
                FOUND=1
                break
              fi
            done
            
            if [ $FOUND -eq 0 ]; then
              echo "ERROR: Project directory not found in common locations."
              exit 1
            else
              echo "Deployment successful."
            fi
            
            # 4. FINAL STATUS CHECK
            echo "Checking container status..."
            docker ps | grep intelskill
