name: Deploy Intelskill.in

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME || 'root' }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.PORT || 22 }}
          script: |
            echo "Starting Deployment..."
            
            # Navigate to project directory
            # Try specific known paths
            PATHS=(
              "/home/intelskill.in/Learn_Flow_Full"
              "/home/intelskill.in"
              "/home/mathisi.in/Learn_Flow_Full" # In case it's here
              "/var/www/intelskill.in"
              "/home/ubuntu/Learn_Flow_Full"
            )
            
            TARGET_DIR=""
            for DIR in "${PATHS[@]}"; do
              if [ -d "$DIR" ] && [ -f "$DIR/docker-compose.yml" ]; then
                TARGET_DIR="$DIR"
                break
              fi
            done
            
            if [ -z "$TARGET_DIR" ]; then
              echo "Error: Could not find project directory containing docker-compose.yml"
              echo "Checked: ${PATHS[*]}"
              # Fallback: Just try to restart valid containers if they exist
              docker restart intelskill-frontend intelskill-backend || true
              exit 1
            fi
            
            echo "Deploying from: $TARGET_DIR"
            cd "$TARGET_DIR"
            
            # Cleanup space
            docker system prune -f
            
            # Update and Restart
            docker compose pull
            docker compose up -d --remove-orphans
            
            echo "Deployment finished. Checking status:"
            docker ps | grep intelskill
